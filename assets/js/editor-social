// ============================================
// EDITOR SOCIAL (JUEGO DE EVALUACI√ìN)
// ============================================

class EditorSocial {
  constructor() {
    this.pasajeActualIndex = 0;
    this.pasajes = [];
    this.xmlDoc = null;
    this.notasEvaluadasEnPasaje = new Set();
  }
  
  /**
   * Inicializar editor social
   */
  async init() {
    console.log('Inicializando Editor Social...');
    
    // Verificar si usuario tiene modo definido
    if (!window.userManager.tieneModoDefinido()) {
      await window.modalModo.mostrar();
    }
    
    // Cargar pasajes desde Supabase
    await this.cargarPasajes();
    
    // Cargar XML de Fuenteovejuna (se cachea)
    this.xmlDoc = await cargarXMLCacheado('../assets/xml/fuenteovejuna.xml');
    
    // Cargar primer pasaje
    await this.cargarPasaje(0);
    
    // Event listeners para controles
    this.setupEventListeners();
    
    console.log('‚úì Editor Social inicializado');
  }
  
  /**
   * Cargar lista de pasajes desde Supabase
   */
  async cargarPasajes() {
    const { data, error } = await window.supabaseClient
      .from('pasajes')
      .select('*')
      .order('orden', { ascending: true });
    
    if (error) {
      console.error('Error al cargar pasajes:', error);
      alert('Error al cargar pasajes. Verifica tu conexi√≥n.');
      return;
    }
    
    this.pasajes = data;
    document.getElementById('pasajes-totales').textContent = this.pasajes.length;
    console.log(`‚úì ${this.pasajes.length} pasajes cargados`);
  }
  
  /**
   * Cargar un pasaje espec√≠fico
   */
  async cargarPasaje(index) {
    if (index < 0 || index >= this.pasajes.length) {
      console.log('Fin de pasajes alcanzado');
      this.mostrarFinalizacion();
      return;
    }
    
    this.pasajeActualIndex = index;
    this.notasEvaluadasEnPasaje.clear();
    
    const pasaje = this.pasajes[index];
    
    // Actualizar UI
    document.getElementById('pasaje-actual').textContent = index + 1;
    
    // Extraer fragmento del XML
    const fragmento = extraerFragmento(this.xmlDoc, pasaje);
    
    if (!fragmento) {
      console.error('No se pudo extraer el fragmento');
      return;
    }
    
    // Renderizar con CETEIcean
    await this.renderizarPasaje(fragmento, pasaje);
    
    // Cargar y renderizar notas
    await this.cargarNotasPasaje(fragmento, pasaje);
  }
  
  /**
   * Renderizar pasaje con CETEIcean
   */
  async renderizarPasaje(fragmento, pasaje) {
    const pasajeContainer = document.getElementById('pasaje-content');
    pasajeContainer.innerHTML = '';
    
    // A√±adir t√≠tulo del pasaje
    const titulo = document.createElement('h2');
    titulo.textContent = pasaje.titulo;
    titulo.style.cssText = 'margin-bottom: 20px; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px;';
    pasajeContainer.appendChild(titulo);
    
    // Renderizar XML con CETEIcean
    const CETEI = new CETEIcean();
    const htmlContent = await CETEI.domToHTML5(fragmento);
    
    // Crear contenedor para el contenido TEI
    const teiContainer = document.createElement('div');
    teiContainer.style.cssText = `
      font-family: 'Google Sans Code', 'Oxygen Mono', 'Source Code Pro', monospace;
      font-weight: 300;
      line-height: 1.8;
      font-size: 16px;
    `;
    teiContainer.appendChild(htmlContent);
    
    pasajeContainer.appendChild(teiContainer);
    
    console.log('‚úì Pasaje renderizado:', pasaje.titulo);
  }
  
  /**
   * Cargar notas del pasaje actual
   */
  async cargarNotasPasaje(fragmento, pasaje) {
    // Obtener xml:ids del fragmento
    const xmlIds = extraerXmlIdsDelFragmento(fragmento);
    
    // Cargar todas las notas activas
    const todasNotas = await cargarNotasActivas();
    
    // Filtrar notas que aplican a este pasaje
    const notasPasaje = filtrarNotasPorXmlIds(todasNotas, xmlIds);
    
    console.log(`‚úì ${notasPasaje.length} notas para el pasaje ${pasaje.titulo}`);
    
    // Renderizar notas
    this.renderizarNotas(notasPasaje, pasaje.id);
  }
  
  /**
   * Renderizar lista de notas con botones de evaluaci√≥n
   */
  renderizarNotas(notas, pasajeId) {
    const notasList = document.getElementById('notas-list');
    notasList.innerHTML = '';
    
    if (notas.length === 0) {
      notasList.innerHTML = '<p style="text-align: center; color: #666;">No hay notas en este pasaje</p>';
      return;
    }
    
    notas.forEach(nota => {
      const notaDiv = document.createElement('div');
      notaDiv.className = 'nota';
      notaDiv.dataset.notaId = nota.nota_id;
      
      notaDiv.innerHTML = `
        <div class="nota-tipo">${this.getTipoNotaLabel(nota.type)}</div>
        <div class="nota-texto">${nota.texto_nota}</div>
        <div class="nota-acciones">
          <button class="btn-util" data-nota-id="${nota.nota_id}" data-version="${nota.version}">
            üëç √ötil
          </button>
          <button class="btn-mejorable" data-nota-id="${nota.nota_id}" data-version="${nota.version}">
            üëé Mejorable
          </button>
        </div>
        <div class="nota-comentario" style="display:none; margin-top: 12px;">
          <textarea placeholder="¬øPor qu√© crees que es mejorable? (opcional)" rows="2" 
                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 13px;"></textarea>
          <div style="margin-top: 8px;">
            <button class="btn-enviar-comentario" style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 6px;">Enviar</button>
            <button class="btn-cancelar-comentario" style="padding: 6px 12px; background: #eee; color: #333; border: none; border-radius: 4px; cursor: pointer;">Cancelar</button>
          </div>
        </div>
      `;
      
      notasList.appendChild(notaDiv);
      
      // Adjuntar event listeners
      this.attachNotaListeners(notaDiv, nota, pasajeId);
    });
  }
  
  /**
   * Obtener etiqueta legible del tipo de nota
   */
  getTipoNotaLabel(tipo) {
    const labels = {
      'lexica': 'L√©xica',
      'parafrasis': 'Par√°frasis',
      'historica': 'Hist√≥rica',
      'cultural': 'Cultural',
      'metrica': 'M√©trica',
      'literaria': 'Literaria'
    };
    return labels[tipo] || tipo;
  }
  
  /**
   * Adjuntar listeners a una nota
   */
  attachNotaListeners(notaDiv, nota, pasajeId) {
    const btnUtil = notaDiv.querySelector('.btn-util');
    const btnMejorable = notaDiv.querySelector('.btn-mejorable');
    const comentarioDiv = notaDiv.querySelector('.nota-comentario');
    const textarea = comentarioDiv.querySelector('textarea');
    const btnEnviar = comentarioDiv.querySelector('.btn-enviar-comentario');
    const btnCancelar = comentarioDiv.querySelector('.btn-cancelar-comentario');
    
    // Bot√≥n "√ötil"
    btnUtil.addEventListener('click', async () => {
      const exito = await this.registrarEvaluacion(
        nota.nota_id, 
        nota.version, 
        'up', 
        null, 
        pasajeId
      );
      
      if (exito) {
        this.marcarNotaVotada(notaDiv, btnUtil, 'up');
      }
    });
    
    // Bot√≥n "Mejorable" - mostrar campo de comentario
    btnMejorable.addEventListener('click', () => {
      comentarioDiv.style.display = 'block';
      textarea.focus();
    });
    
    // Bot√≥n "Enviar comentario"
    btnEnviar.addEventListener('click', async () => {
      const comentario = textarea.value.trim() || null;
      const exito = await this.registrarEvaluacion(
        nota.nota_id, 
        nota.version, 
        'down', 
        comentario, 
        pasajeId
      );
      
      if (exito) {
        this.marcarNotaVotada(notaDiv, btnMejorable, 'down');
      }
    });
    
    // Bot√≥n "Cancelar"
    btnCancelar.addEventListener('click', () => {
      comentarioDiv.style.display = 'none';
      textarea.value = '';
    });
  }
  
  /**
   * Registrar evaluaci√≥n en Supabase
   */
  async registrarEvaluacion(notaId, version, vote, comentario, pasajeId) {
    // Verificar modo de usuario (por si acaso)
    if (!window.userManager.tieneModoDefinido()) {
      await window.modalModo.mostrar();
    }
    
    const datosUsuario = window.userManager.obtenerDatosUsuario();
    
    const evaluacion = {
      timestamp: new Date().toISOString(),
      source: 'editor-social',
      event_type: 'nota_eval',
      session_id: datosUsuario.session_id,
      pasaje_id: pasajeId,
      nota_id: notaId,
      nota_version: version,
      vote: vote,
      comment: comentario
    };
    
    const { error } = await window.supabaseClient
      .from('evaluaciones')
      .insert(evaluacion);
    
    if (error) {
      console.error('Error al registrar evaluaci√≥n:', error);
      mostrarToast('Error al enviar evaluaci√≥n', 3000);
      return false;
    }
    
    console.log('‚úì Evaluaci√≥n registrada:', vote, notaId);
    this.notasEvaluadasEnPasaje.add(notaId);
    return true;
  }
  
  /**
   * Marcar nota como votada visualmente
   */
  marcarNotaVotada(notaDiv, boton, voto) {
    const botonesDiv = notaDiv.querySelector('.nota-acciones');
    const comentarioDiv = notaDiv.querySelector('.nota-comentario');
    
    // Deshabilitar botones
    const botones = botonesDiv.querySelectorAll('button');
    botones.forEach(btn => btn.disabled = true);
    
    // A√±adir clase 'votado' al bot√≥n presionado
    boton.classList.add('votado');
    boton.textContent = voto === 'up' ? '‚úì Votado' : '‚úì Votado';
    
    // Ocultar campo de comentario si est√° visible
    comentarioDiv.style.display = 'none';
    
    // Toast
    mostrarToast(voto === 'up' ? 'Nota marcada como √∫til' : 'Gracias por tu feedback', 2000);
  }
  
  /**
   * Configurar event listeners de controles
   */
  setupEventListeners() {
    // Bot√≥n "Siguiente"
    document.getElementById('btn-siguiente').addEventListener('click', () => {
      this.siguientePasaje();
    });
    
    // Bot√≥n "Saltar"
    document.getElementById('btn-saltar').addEventListener('click', () => {
      if (confirm('¬øSeguro que quieres saltar este pasaje sin evaluar?')) {
        this.siguientePasaje();
      }
    });
  }
  
  /**
   * Ir al siguiente pasaje
   */
  siguientePasaje() {
    // Scroll al top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Cargar siguiente pasaje
    this.cargarPasaje(this.pasajeActualIndex + 1);
  }
  
  /**
   * Mostrar pantalla de finalizaci√≥n
   */
  mostrarFinalizacion() {
    const container = document.querySelector('.editor-social-container');
    container.innerHTML = `
      <div style="text-align: center; padding: 60px 20px;">
        <h1 style="font-size: 3rem; color: #4caf50; margin-bottom: 20px;">üéâ ¬°Felicidades!</h1>
        <p style="font-size: 1.5rem; color: #666; margin-bottom: 30px;">
          Has completado todos los pasajes disponibles
        </p>
        <p style="font-size: 1.2rem; color: #999; margin-bottom: 40px;">
          Gracias por tu contribuci√≥n al proyecto
        </p>
        <a href="../index.html" class="btn" style="font-size: 1.2rem; padding: 15px 40px;">
          Volver al inicio
        </a>
      </div>
    `;
    
    mostrarToast('¬°Has completado todos los pasajes!', 4000);
  }
}

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', async () => {
  window.editorSocial = new EditorSocial();
  await window.editorSocial.init();
});

console.log('‚úì Editor Social cargado');
